{% extends "layouts/base.html" %}

{% block title %}Despacho - Orden {{ orden.codigo_oc }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header card-header-primary">
                <h4 class="card-title">Despacho  - Orden {{ orden.codigo_oc }}</h4>
                <p class="card-category">Cliente: {{ orden.cliente.nombre_cliente }} | Fecha: {{ orden.fecha_solicitud }}</p>
            </div>
            <div class="card-body">
                
                <!-- Sección de Productos Pendientes -->
                <h5 class="text-primary mb-3"> Productos Pendientes de Despacho</h5>
                {% if productos_pendientes %}
                <form method="post" id="despachoForm">
                    {% csrf_token %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th width="5%">
                                        <input type="checkbox" id="selectAll" style="transform: scale(1.2);">
                                    </th>
                                    <th>Referencia</th>
                                    <th>Solicitado</th>
                                    <th>Despachado</th>
                                    <th>Pendiente</th>
                                    <th>Cantidad a Despachar</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in productos_pendientes %}
                                {% if producto.pendiente > 0 %}
                                <tr>
                                    <td>
                                        <input type="checkbox" name="productos_seleccionados" 
                                               value="{{ producto.id }}" 
                                               class="producto-checkbox" 
                                               style="transform: scale(1.2);">
                                    </td>
                                    <td><strong>{{ producto.producto.referencia }}</strong></td>
                                    <td>{{ producto.cantidad }}</td>
                                    <td>{{ producto.despachado }}</td>
                                    <td><span class="badge badge-warning">{{ producto.pendiente }}</span></td>
                                    <td>
                                        <input type="number" name="cantidad_{{ producto.id }}" 
                                               class="form-control cantidad-input" 
                                               min="1" max="{{ producto.pendiente }}" 
                                               value="{{ producto.pendiente }}" 
                                               style="width: 100px;" disabled>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3 d-flex justify-content-between align-items-center">
                        <div>
                            <span id="contadorSeleccionados" class="text-muted">0 productos seleccionados</span>
                        </div>
                        <button type="button" class="btn btn-success btn-lg" id="realizarDespacho" disabled onclick="confirmarDespacho()">
                            <i class="material-icons">local_shipping</i> Realizar Despacho 
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="alert alert-info">
                    <i class="material-icons">info</i> No hay productos pendientes de despacho para esta orden.
                </div>
                {% endif %}

                <hr class="my-4">

                <!-- Sección de Productos Despachados -->
                <h5 class="text-success mb-3"> Productos Despachados</h5>
                {% if productos_despachados %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Referencia</th>
                                <th>Solicitado</th>
                                <th>Despachado</th>
                                <th>Pendiente</th>
                                <th>Estado</th>
                                <th>Detalles</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for producto in productos_despachados %}
                            <tr>
                                <td><strong>{{ producto.producto.referencia }}</strong></td>
                                <td>{{ producto.cantidad }}</td>
                                <td><span class="badge badge-success">{{ producto.despachado }}</span></td>
                                <td>
                                    {% if producto.pendiente > 0 %}
                                        <span class="badge badge-warning">{{ producto.pendiente }}</span>
                                    {% else %}
                                        <span class="badge badge-success">0</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if producto.completado %}
                                        <span class="badge badge-success">Completado</span>
                                    {% else %}
                                        <span class="badge badge-warning">Parcial</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary" 
                                            data-toggle="collapse" 
                                            data-target="#detalles_{{ producto.id }}">
                                        Ver Detalles
                                    </button>
                                    <div class="collapse mt-2" id="detalles_{{ producto.id }}">
                                        <div class="card card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Fecha Despacho</th>
                                                            <th>Cantidad</th>
                                                            <th>Estado</th>
                                                            <th>Fecha Reintegro</th>
                                                            <th>Acción</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for despacho in producto.despachos.all %}
                                                        <tr>
                                                            <td><small>{{ despacho.fecha_despacho|date:"d/m/Y H:i" }}</small></td>
                                                            <td><strong>{{ despacho.cantidad }}</strong></td>
                                                            <td>
                                                                {% if despacho.reintegro %}
                                                                    <span class="badge badge-danger">REINTEGRADO</span>
                                                                {% else %}
                                                                    <span class="badge badge-success">ACTIVO</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if despacho.reintegro %}
                                                                    <small>{{ despacho.fecha_reintegro|date:"d/m/Y H:i" }}</small>
                                                                {% else %}
                                                                    <small class="text-muted">-</small>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if not despacho.reintegro %}
                                                                <button type="button" class="btn btn-sm btn-warning" 
                                                                        onclick="confirmarReintegro({{ despacho.id }})">
                                                                    <i class="material-icons" style="font-size: 16px;">undo</i>
                                                                </button>
                                                                {% else %}
                                                                <small class="text-muted">-</small>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="material-icons">info</i> Aún no se han realizado despachos para esta orden.
                </div>
                {% endif %}

                <div class="mt-4">
                    <a href="{% url 'buscar_orden' %}" class="btn btn-secondary">
                        <i class="material-icons">arrow_back</i> Volver a Búsqueda
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Despacho -->
<div class="modal fade" id="modalConfirmarDespacho" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="material-icons">warning</i> Confirmar Despacho
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="modalDespachoTexto"></p>
                <p class="text-muted">Esta acción registrará los despachos seleccionados y generará una remisión automáticamente.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="ejecutarDespacho()">
                    <i class="material-icons">local_shipping</i> Confirmar Despacho
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Reintegro -->
<div class="modal fade" id="modalConfirmarReintegro" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="material-icons">warning</i> Confirmar Reintegro
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de reintegrar este despacho?</p>
                <p class="text-danger"><strong>Esta acción no se puede deshacer.</strong></p>
                <p class="text-muted">El producto volverá a estar disponible para despacho.</p>
                <input type="hidden" id="reintegroId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="ejecutarReintegro()">
                    <i class="material-icons">undo</i> Confirmar Reintegro
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const productoCheckboxes = document.querySelectorAll('.producto-checkbox');
    const realizarDespachoBtn = document.getElementById('realizarDespacho');
    const contadorSeleccionados = document.getElementById('contadorSeleccionados');

    // Función para actualizar el estado del botón y contador
    function updateUI() {
        const checkedBoxes = document.querySelectorAll('.producto-checkbox:checked');
        const count = checkedBoxes.length;
        
        // Actualizar botón
        realizarDespachoBtn.disabled = count === 0;
        
        // Actualizar contador
        contadorSeleccionados.textContent = `${count} producto${count !== 1 ? 's' : ''} seleccionado${count !== 1 ? 's' : ''}`;
        
        // Actualizar estado del checkbox general
        const totalCheckboxes = productoCheckboxes.length;
        if (count === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (count === totalCheckboxes) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    // Checkbox general - seleccionar/deseleccionar todos
    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        productoCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            const cantidadInput = document.querySelector(`input[name="cantidad_${checkbox.value}"]`);
            cantidadInput.disabled = !isChecked;
            
            // Efecto visual en la fila
            const row = checkbox.closest('tr');
            if (isChecked) {
                row.classList.add('table-active');
            } else {
                row.classList.remove('table-active');
            }
        });
        updateUI();
    });

    // Checkboxes individuales
    productoCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const cantidadInput = document.querySelector(`input[name="cantidad_${this.value}"]`);
            cantidadInput.disabled = !this.checked;
            
            // Efecto visual en la fila
            const row = this.closest('tr');
            if (this.checked) {
                row.classList.add('table-active');
            } else {
                row.classList.remove('table-active');
            }
            
            updateUI();
        });
    });

    // Validación de cantidades en tiempo real
    document.querySelectorAll('.cantidad-input').forEach(input => {
        input.addEventListener('input', function() {
            const max = parseInt(this.getAttribute('max'));
            const value = parseInt(this.value);
            
            if (value > max) {
                this.value = max;
                this.style.borderColor = '#f44336';
                setTimeout(() => {
                    this.style.borderColor = '';
                }, 2000);
            }
        });
    });

    // Estado inicial
    updateUI();
});

function confirmarDespacho() {
    const checkedBoxes = document.querySelectorAll('.producto-checkbox:checked');
    if (checkedBoxes.length === 0) return;
    
    document.getElementById('modalDespachoTexto').textContent = 
        `¿Está seguro de realizar el despacho de ${checkedBoxes.length} producto(s)?`;
    $('#modalConfirmarDespacho').modal('show');
}

function confirmarReintegro(despachoId) {
    document.getElementById('reintegroId').value = despachoId;
    $('#modalConfirmarReintegro').modal('show');
}

function ejecutarDespacho() {
    // Validar cantidades antes de enviar
    let valid = true;
    const checkedBoxes = document.querySelectorAll('.producto-checkbox:checked');
    
    checkedBoxes.forEach(checkbox => {
        const cantidadInput = document.querySelector(`input[name="cantidad_${checkbox.value}"]`);
        const max = parseInt(cantidadInput.getAttribute('max'));
        const value = parseInt(cantidadInput.value);
        
        if (value > max || value <= 0) {
            valid = false;
            cantidadInput.style.borderColor = '#f44336';
        }
    });
    
    if (valid) {
        document.getElementById('despachoForm').submit();
    } else {
        alert('Error: Verifique las cantidades ingresadas.');
    }
}

function ejecutarReintegro() {
    const despachoId = document.getElementById('reintegroId').value;
    window.location.href = `/despachos/reintegrar/${despachoId}/`;
}
</script>
{% endblock %}